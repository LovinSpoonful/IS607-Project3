---
title: "IS607 Project 3"
author: "Rob, Armenoush, Keith, Dan B, Aadi" 
date: "March 16, 2016"
output: html_document
---


```
#save in case we need this
sqlUpdate(channel, dat, tablename = NULL, index = NULL, verbose = FALSE, test = FALSE, nastring = NULL, fast = TRUE)

```

if we don't have an ODBC driver, can connect to the db using rMySQL
```
library(RMySQL)
db <- dbConnect(MySQL(), user='project3', password='CUNYRBridge4', dbname='skill', host='85.10.205.173')
dbListTables(db)
dbDisconnect(db)
```


```{r}

# Establish connection to the database
library(RODBC)
#cnString <- "MySQL_ANSI;SERVER=localhost;DATABASE=skill;UID=root;PASSWORD=CUNYRBridge4!;OPTION=3;"
cnString <- "MySQL_ANSI;SERVER=db4free.net;DATABASE=skill;UID=project3;PASSWORD=CUNYRBridge4;OPTION=3;"
db <- odbcConnect(cnString, case="nochange")

#manually input the list of csv files on github

#test data
#sources <- c("https://raw.githubusercontent.com/LovinSpoonful/IS607-Project3/39c575afb60c2ca7d309bb1bdc522b6135df85a2/skills2010.csv",
#             "https://raw.githubusercontent.com/LovinSpoonful/IS607-Project3/39c575afb60c2ca7d309bb1bdc522b6135df85a2/skills2013.csv",
#             "https://raw.githubusercontent.com/LovinSpoonful/IS607-Project3/39c575afb60c2ca7d309bb1bdc522b6135df85a2/skills2014.csv",
#             "https://raw.githubusercontent.com/LovinSpoonful/IS607-Project3/56e8b1c400691cba256d36c9ed33a2478121ff2f/skillsdis.csv")

#real data
sources <- c("https://raw.githubusercontent.com/LovinSpoonful/IS607-Project3/master/08-barman-data-cleaned.csv",
             "https://raw.githubusercontent.com/LovinSpoonful/IS607-Project3/master/09-briot-data-cleaned.csv",
             "https://raw.githubusercontent.com/LovinSpoonful/IS607-Project3/master/10-karr-data-cleaned.csv",
             "https://raw.githubusercontent.com/LovinSpoonful/IS607-Project3/master/11-fanelli-data-cleaned.csv")
       
```



```{r}

# Import all the source data into the database

sqlQuery(db,"DELETE FROM tbl_import;") # first truncate the imported records table
sqlQuery(db,"DELETE FROM tbl_source;") # also empty the sources table

# Loop through every source data file
for (i in 1:length(sources)){

  #record the source of the data in the sources table
  dat <- read.csv(file = sources[i], header=FALSE, sep=",") 
  source_id <- i
  source_name <- as.character(dat[1,1])  # get the source name from the top row of the data file
  source_url <- as.character(dat[2,1])   # get the source URL from 2nd row
  sSQL <- paste("INSERT INTO tbl_source VALUES (", source_id, ", '", gsub(" ", "_", source_name), "', '", source_name, "', '", source_url, "')",   sep = "", collapse = NULL)  # write this information into the sources table
  sqlQuery(db,sSQL)

  #export all the data for this source into the database (the Import table)
  dat <- dat[-1:-3,] #remove the header lines
  source_id <- rep(i,nrow(dat)) # create a column to show which data set these samples came from
  dat <- data.frame(source_id,dat) # add that column to the front of the dataframe
  names(dat) <- c("source_id","skill_type_name","skill_name","rating")  #hardcode the column names.  should get them from the table definition!
  sqlSave(db, dat, tablename = "tbl_import", rownames=FALSE, append=TRUE) # write the dataframe to the mySQL table
}

```

Deduplicate the data and setup the Skills Types, Skills Names tables

```{r}

# retrieve the imported records into a data frame
df <- sqlQuery(db,"SELECT source_id, skill_type_name, skill_name, ROUND(AVG(rating),3) rating FROM tbl_import GROUP BY source_id, skill_type_name, skill_name ORDER BY source_id, skill_type_name, skill_name;", stringsAsFactors = FALSE)  

# write the de-duplicated import records back into the database
sqlQuery(db,"DELETE FROM tbl_import;") # first truncate the imported records table
sqlSave(db, df, tablename = "tbl_import", rownames=FALSE, append=TRUE) # write the dataframe to the mySQL table

# create a master list of skill types (using r)
sqlQuery(db,"DELETE FROM tbl_skill_type") # first truncate the imported records table
skill_type_name <- unique(df$skill_type_name,incomparables = FALSE, stringsAsFactors = FALSE)
skill_type_id <- c(1:length(skill_type_name))
skill_type_description <- skill_type_name # enrich later if can get descriptions
df1 <- data.frame(skill_type_id,skill_type_name, skill_type_description) # create a dataframe that matches the table structure
sqlSave(db, df1, tablename = "tbl_skill_type", rownames=FALSE, append=TRUE) # write the dataframe to the mySQL table

# create a master list of skill names (using my sql)
sqlQuery(db,"DELETE FROM tbl_skill;") # first truncate the imported records table
sqlQuery(db,"INSERT INTO tbl_Skill (skill_id, skill_type_id, skill_name) SELECT NULL, st.skill_type_id, i.skill_name FROM tbl_import i JOIN tbl_skill_type st ON st.skill_type_name = i.skill_type_name GROUP BY st.skill_type_id, i.skill_name;")

```


Populate the normalized table of values

```{r}

sqlQuery(db,"DELETE FROM tbl_data_n;") # first truncate it
# populate the data table
sSQL <- paste("INSERT INTO tbl_data_n (skill_type_id, skill_id, source_id, rating) ",
              "SELECT s.skill_type_id, s.skill_id, i.source_id, i.rating         ",
              "FROM tbl_skill s                                                  ",
              "JOIN tbl_skill_type st ON s.skill_type_id = st.skill_type_id      ",
              "JOIN tbl_import i ON i.skill_name = s.skill_name;                 ", sep = "")
sqlQuery(db,sSQL)

```

To make it easier to create analysis views, create a master view with all the descriptors

```{r}

sqlQuery(db,"DROP VIEW IF EXISTS `vw_data`;")
sSQL <- paste("CREATE VIEW `vw_data` AS ",
              "SELECT s.skill_type_id, s.skill_id, i.source_id, st.skill_type_name, s.skill_name, so.source_name, so.source_description, i.rating ",
              "FROM tbl_skill s ",
              "JOIN tbl_skill_type st ON s.skill_type_id = st.skill_type_id ",
              "JOIN tbl_import i ON i.skill_name = s.skill_name ",
              "JOIN tbl_source so ON so.source_id = i.source_id;")
sqlQuery(db,sSQL)  

```

next we want to add scaled values, (from 0 to 1) linear, and also logarithmic.



```
so the presenter will get a set of views, which they can get with a single line of code
like this "df <- sqlQuery(db,"SELECT * FROM vw_Top10_Skills_All")"
```


